<!DOCTYPE html>
<html>
	<head>
		<script src="scripts/jquery.min.js"></script>
		<script src="scripts/bootstrap.min.js"></script>
		<link rel="stylesheet" href="styles/bootstrap.min.css">
	</head>
	<body>
		<div class="container mt-3">
			<h1>Upravljanje OpenVPN stre≈ænika</h1>
			<div class="input-group mb-4">
				<div class="input-group-prepend">
					<span class="input-group-text" id="domain-addon">Domena:</span>
				</div>
				<input type="text" disabled class="form-control" placeholder="vasa.domena.si" aria-label="Domena" aria-describedby="domain-addon" id="domain">
			</div>
			<div class="row mb-3">
				<div class="col-8">
					<div class="card">
						<div class="card-body">
							<h3 class="mb-3">Uporabniki:</h3>
							<table class="table table-sm text-center">
							<thead>
								<tr>
									<th scope="col">Ime</th>
									<th scope="col">Velja od</th>
									<th scope="col">Velja do</th>
									<th scope="col">Stanje</th>
									<th scope="col">.ovpn</th>
									<th scope="col">Razveljavi</th>
								</tr>
							</thead>
							<tbody id="user-table-body">
							</tbody>
							</table>
							<h6>Ustvari novega uporabnika:</h6>
							<div class="input-group mb-3">
								<input type="text" class="form-control" placeholder="Up. ime" aria-label="Username" aria-describedby="add-user" id="username">
								<div class="input-group-append">
									<button class="btn btn-primary" type="button" id="add-user" onClick="addUser()">Dodaj</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-4">
					<div class="card">
						<div class="card-body">
							
						</div>
					</div>
				</div>
			</div>
		</div>
		<script>
			let clientRowTemplate = document.createElement('tr');
			
			let nameCol = document.createElement('td');
			let startCol = document.createElement('td');
			let endCol = document.createElement('td');
			let statusCol = document.createElement('td');
			let ovpnCol = document.createElement('td');
			let revCol = document.createElement('td');
			
			let ovpnButton = document.createElement('button');
			let revButton = document.createElement('button');
			
			clientRowTemplate.appendChild(nameCol);
			clientRowTemplate.appendChild(startCol);
			clientRowTemplate.appendChild(endCol);
			clientRowTemplate.appendChild(statusCol);
			clientRowTemplate.appendChild(ovpnCol);
			clientRowTemplate.appendChild(revCol);
			
			ovpnCol.appendChild(ovpnButton);
			revCol.appendChild(revButton);
			
			ovpnButton.className = 'btn-sm btn-secondary';
			revButton.className = 'btn-sm btn-danger';
			
			ovpnButton.innerText = 'Prenesi';
			revButton.innerText = 'Razveljavi';
			
		
			function getClientList() {
				$.getJSON('/clientList.json', function(data) {
					tbody = document.getElementById('user-table-body');
					tbody.innerHTML = '';
					for (client of data) {
						switch (client.status) {
							case 'VALID':
								statusCol.innerText = 'Veljaven';
								break;
							case 'EXPIRED':
								statusCol.innerText = 'Potekel';
								break;
							case 'REVOKED':
								statusCol.innerText = 'Razveljavljen';
								break;
							case 'EXPIRED':
								statusCol.innerText = 'Neveljaven';
								break;
						}
						nameCol.innerText = client.name;
						startCol.innerText = new Date(Date.parse(client.begin)).toLocaleString();
						endCol.innerText = new Date(Date.parse(client.end)).toLocaleString();
						
						ovpnButton.setAttribute('onClick', 'downloadOvpn(\'' + client.name + '\');');
						revButton.setAttribute('onClick', 'revokeClient(\'' + client.name + '\')');
						
						tbody.innerHTML += clientRowTemplate.outerHTML;
					}
				});
			}
			
			window.addEventListener('load', function() {
				getClientList();
			});
			
			function addUser() {
				username = document.getElementById('username').value;
				$.get('/addClient?username=' + username);
				getClientList();
			}
		</script>
	</body>
</html>
